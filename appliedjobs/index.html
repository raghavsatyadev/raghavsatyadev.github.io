<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Android Native Developer Jobs 4-10 YOE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            width: 120px;
        }

        .icon {
            font-size: 60px;
        }

        .hidden {
            display: none;
        }

        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<h1>Applied Jobs</h1>
<!-- We'll show/hide this depending on the view -->
<button id="backBtn" class="back-button hidden">Back</button>
<div id="jsonTree" class="container"></div>

<script>
    // Base GitHub API
    const apiUrl = 'https://api.github.com/repos/raghavsatyadev/raghavsatyadev.github.io/contents/appliedjobs/jsons/';
    const CACHE_DURATION_MS = 20 * 60 * 60 * 1000; // 20 Hours

    // Page Load: Decide if we need the back button
    function maybeShowBackButton() {
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view');
        // If view is not set or is 'year', we are at the top-level (hide button).
        // Otherwise, show button for 'month' or 'file'.
        const hideBackButton = (!view || view === 'year');
        document.getElementById('backBtn').className = hideBackButton ? "hidden" : "back-button";
    }

    // Our custom back button just calls the system history back
    document.getElementById('backBtn').addEventListener('click', () => history.back());

    // -------------------- Data Fetch with 7-Day Caching --------------------
    async function fetchData(url) {
        const cacheKey = `cache_${url}`;
        // 1) Check localStorage
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const cachedObj = JSON.parse(cached);
            if (Date.now() < cachedObj.expiry) {
                console.log('Returning cached data for:', url);
                return cachedObj.data;
            } else {
                localStorage.removeItem(cacheKey);
            }
        }
        // 2) If no valid cache, fetch from GitHub
        const response = await fetch(url,);
        if (!response.ok) {
            console.error(`Failed to fetch data from ${url}:`, response.statusText);
            return [];
        }
        const data = await response.json();
        // 3) Store in cache for 7 days
        const expiry = Date.now() + CACHE_DURATION_MS;
        localStorage.setItem(cacheKey, JSON.stringify({data, expiry}));
        return data;
    }

    // -------------------- Load Year Folders (Default View) --------------------
    async function loadYearFolders() {
        console.log('Loading Year Folders...');
        const years = await fetchData(apiUrl);
        years.sort((a, b) => b.name.localeCompare(a.name)); 
        renderItems(years, 'year');
    }
    const monthOrder = {
        "January": 1, "February": 2, "March": 3, "April": 4,
        "May": 5, "June": 6, "July": 7, "August": 8,
        "September": 9, "October": 10, "November": 11, "December": 12
    };
    // -------------------- Load Month Folders for a Specific Year --------------------
    async function loadMonthFolders(year) {
        console.log('Loading Month Folders for:', year);
        const url = `${apiUrl}${year}`;
        const months = await fetchData(url);
        months.sort((a, b) => monthOrder[b.name] - monthOrder[a.name]);
        renderItems(months, 'month', year);
    }

    // -------------------- Load JSON Files for a Specific Month --------------------
    async function loadJsonFiles(year, month) {
        console.log('Loading JSON Files for:', year, month);
        const url = `${apiUrl}${year}/${month}`;
        const files = await fetchData(url);
        files.sort((a, b) => {
            const dateA = new Date(a.name.split('.json')[0].split('-').reverse().join('-')); // Convert to YYYY-MM-DD
            const dateB = new Date(b.name.split('.json')[0].split('-').reverse().join('-'));
            return dateB - dateA; // Sort latest first
        });
        renderItems(files, 'file', year, month);
    }

    // -------------------- Render Items (Year, Month, File) --------------------
    function renderItems(items, view, year = '', month = '') {
        // Clear UI
        const container = document.getElementById('jsonTree');
        container.innerHTML = '';

        // Show or hide our custom back button as needed
        maybeShowBackButton();

        items.forEach(item => {
            // Year
            if (view === 'year' && item.type === 'dir') {
                createItem(item.name, 'ðŸ“', () => {
                    // Navigate to month view in URL
                    window.location.href = `index.html?view=month&year=${item.name}`;
                });
            }
            // Month
            else if (view === 'month' && item.type === 'dir') {
                createItem(item.name, 'ðŸ“', () => {
                    // Navigate to file view in URL
                    window.location.href = `index.html?view=file&year=${year}&month=${item.name}`;
                });
            }
            // File
            else if (view === 'file' && item.type === 'file' && item.name.endsWith('.json')) {
                createItem(item.name, 'ðŸ“„', () => {
                    // Go to jobs.html with no "appliedjobs/jsons" in param
                    window.location.href = `jobs.html?file=${item.name}&year=${year}&month=${month}`;
                });
            }
        });
    }

    // -------------------- Helper: Create Clickable Item --------------------
    function createItem(name, icon, onClick) {
        const div = document.createElement('div');
        div.classList.add('item');
        div.innerHTML = `<div class="icon">${icon}</div><span>${name}</span>`;
        div.addEventListener('click', onClick);
        document.getElementById('jsonTree').appendChild(div);
    }

    // -------------------- Page Init --------------------
    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view');
        const year = params.get('year');
        const month = params.get('month');

        if (view === 'month' && year) {
            await loadMonthFolders(year);
        } else if (view === 'file' && year && month) {
            await loadJsonFiles(year, month);
        } else {
            // Default => Show Year Folders
            await loadYearFolders();
        }
    });
</script>
</body>
</html>
